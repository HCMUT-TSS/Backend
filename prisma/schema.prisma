// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

// ====================== USER - SSO CORE ======================
model User {
  id          Int       @id @default(autoincrement())
  ssoSub      String    @unique @db.NVarChar(100)
  ssoProvider String    @default("hcmut") @db.VarChar(50)
  email       String    @unique @db.NVarChar(255)
  name        String?   @db.NVarChar(255)
  phoneNumber String?   @db.VarChar(20)
  dateOfBirth DateTime? @db.Date
  admissionDate DateTime? @db.Date
  faculty     String?   @db.NVarChar(255)
  role        String    @default("student") @db.VarChar(20)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  student     Student?
  tutor       Tutor?
  admin       Admin?

  // QUAN HỆ NGƯỢC → PHẢI ĐẶT TÊN ĐÚNG VỚI BÊN KIA
  posts       Post[]      @relation("PostAuthor")
  comments    Comment[]   @relation("CommentAuthor")

  @@map("Users")
}

// ====================== STUDENT ======================
model Student {
  userId      Int    @id
  mssv        String @unique @db.VarChar(20) // trùng với ssoSub của sinh viên

  // Đồng bộ từ Datacore (tùy chọn mở rộng sau)
  facultyCode String? @db.VarChar(10)
  majorCode   String? @db.VarChar(10)
  classCode   String? @db.VarChar(20)
  gpa         Decimal? @db.Decimal(4, 2)
  credits     Int?

  user        User   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  requestBookings RequestBooking[]
  programStudents TutorProgramStudent[]
  sessionStudents SessionStudent[]
  attendances     Attendance[]

  @@map("Students")
  @@index([mssv])
}

// ====================== TUTOR ======================
model Tutor {
  userId     Int      @id
  status     String   @default("pending") @db.VarChar(20) // pending | approved | rejected | banned
  appliedAt  DateTime @default(now())
  approvedAt DateTime?
  rejectedAt DateTime?

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  schedules       Schedule[]
  programs        TutorProgramTutor[]
  bookingRequests RequestBooking[]

  @@map("Tutors")
}

// ====================== ADMIN ======================
model Admin {
  userId Int  @id
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@map("Admins")
}

// ====================== REQUEST BOOKING (yêu cầu gia sư) ======================
model RequestBooking {
  id           Int      @id @default(autoincrement())
  studentId    Int
  tutorId      Int?     
  subject      String?  @db.NVarChar(255)
  description  String?  @db.NVarChar(Max)

  preferredDate DateTime? @db.Date         // Ngày sinh viên muốn gặp (2025-12-15)
  startTime    String?   @db.VarChar(5)    
  endTime      String?   @db.VarChar(5)  

  location      String?   @db.NVarChar(255) // Lưu địa điểm
  meetLink      String?   @db.NVarChar(500) // Lưu link họp
  scheduleTitle String?   @db.NVarChar(255)

  status       String    @default("pending") @db.VarChar(50)
  createdAt    DateTime  @default(now())
  matchedAt    DateTime?
  confirmedAt  DateTime?
  cancelledAt  DateTime?

  student Student @relation(fields: [studentId], references: [userId], onDelete: NoAction, onUpdate: NoAction)
  tutor   Tutor?  @relation(fields: [tutorId],   references: [userId], onDelete: SetNull,  onUpdate: NoAction)

  @@map("RequestBookings")
  @@index([studentId])
  @@index([tutorId])
  @@index([status])
  @@index([preferredDate]) 
}

// ====================== SCHEDULE (lịch cố định tutor) ======================
model Schedule {
  id           Int      @id @default(autoincrement())
  tutorId      Int
  dayOfWeek    Int      // 0 = CN, 1 = T2, ..., 6 = T7
  startTime    String   @db.VarChar(10)  // "14:00"
  endTime      String   @db.VarChar(10)  // "16:00"
  isActive     Boolean  @default(true)
  tutor        Tutor    @relation(fields: [tutorId], references: [userId], onDelete: Cascade)
  meetingType  String   @default("online") @db.VarChar(20) // "online" | "offline"
  meetLink     String?  @db.NVarChar(500) 
  location     String?  @db.NVarChar(255)           

  sessions     Session[]
  title     String?  
  posts       Post[]

  @@unique([tutorId, dayOfWeek, startTime])
  @@map("Schedules")
}

// ====================== CHƯƠNG TRÌNH GIA SƯ NHÓM ======================
model TutorProgram {
  id          Int      @id @default(autoincrement())
  title       String   @db.NVarChar(255)
  description String?  @db.NVarChar(Max)
  timeOpen    DateTime? @db.Time
  timeClose   DateTime? @db.Time
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  students TutorProgramStudent[]
  tutors   TutorProgramTutor[]

  @@map("TutorPrograms")
}

model TutorProgramStudent {
  programId Int
  studentId Int

  program TutorProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  student Student     @relation(fields: [studentId], references: [userId], onDelete: Cascade)

  @@id([programId, studentId])
  @@map("TutorProgramStudents")
}

model TutorProgramTutor {
  programId Int
  tutorId   Int

  program TutorProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  tutor   Tutor       @relation(fields: [tutorId], references: [userId], onDelete: Cascade)

  @@id([programId, tutorId])
  @@map("TutorProgramTutors")
}

// ====================== BUỔI HỌC ======================
model Session {
  id          Int       @id @default(autoincrement())
  scheduleId  Int
  topic       String?   @db.NVarChar(255)
  status      String    @default("scheduled") @db.VarChar(50)
  day         DateTime  @db.Date

  schedule    Schedule  @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  
  // ĐỔI TÊN: resources → sessionResources (tránh xung đột với Resource của Post)
  sessionResources SessionResource[]
  students    SessionStudent[]
  attendances Attendance[]
  // posts       Post[]

  @@map("Sessions")
  @@index([day])
}

model Attendance {
  sessionId Int
  studentId Int
  status    String    @default("absent") @db.VarChar(20)
  checkedAt DateTime?

  session   Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  student   Student   @relation(fields: [studentId], references: [userId], onDelete: NoAction, onUpdate: NoAction)

  @@id([sessionId, studentId])
  @@map("Attendances")
}

model SessionStudent {
  sessionId Int
  studentId Int

  session   Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  student   Student   @relation(fields: [studentId], references: [userId], onDelete: NoAction, onUpdate: NoAction)

  @@id([sessionId, studentId])
  @@map("SessionStudents")
}

// ====================== TÀI LIỆU ======================
model SessionResource {
  id        Int       @id @default(autoincrement())
  sessionId Int
  name      String    @db.NVarChar(255)
  type      String?   @db.NVarChar(100)
  url       String    @db.NVarChar(Max)

  session   Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("Resources") // vẫn giữ tên bảng cũ để không mất dữ liệu
}
model Post {
  id         Int       @id @default(autoincrement())
  // sessionId  Int
  authorId   Int
  title      String    @db.NVarChar(500)
  content    String    @db.NVarChar(Max)
  category   String?   @default("class")
  isPinned   Boolean   @default(false)
  likes      Int       @default(0)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // session    Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  author     User      @relation("PostAuthor", fields: [authorId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  scheduleId  Int      
  schedule    Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  comments   Comment[]
  resources  CommunityResource[]  // DÙNG CommunityResource

  @@map("Posts")
}

model Comment {
  id        Int       @id @default(autoincrement())
  postId    Int
  authorId    Int
  content   String    @db.NVarChar(Max)
  createdAt DateTime  @default(now())

  post      Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  // QUAN HỆ ĐÚNG VỚI USER → PHẢI ĐẶT TÊN "CommentAuthor"
  author    User      @relation("CommentAuthor", fields: [authorId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@map("Comments")
}

model CommunityResource {
  id        Int       @id @default(autoincrement())
  postId    Int
  name      String    @db.NVarChar(255)
  type      String    @default("link") @db.VarChar(50)
  url       String    @db.NVarChar(Max)
  createdAt DateTime  @default(now())

  post      Post      @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@map("CommunityResources")
}